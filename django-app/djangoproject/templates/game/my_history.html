{% extends 'base.html' %}

{% block title %}My History - Enchantext{% endblock %}

{% block content %}
<div class="card">
    <h1 style="display:flex; align-items:center; gap:10px;">
            <img src="https://img.icons8.com/nolan/40/order-history.png" alt="order-history"/> My Play History</h1>
    <p>Review your completed adventures and see which endings you've discovered</p>
</div>

{% if play_data %}
    <div class="card">
        <h2>Completed Stories ({{ play_data|length }})</h2>
    </div>

    {% for item in play_data %}
        <div class="card" style="background: #f8f9fa;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 0.5rem 0;">
                        <a href="{% url 'story_detail' item.story.id %}" 
                           style="color: #667eea; text-decoration: none;">
                            {{ item.story.title }}
                        </a>
                    </h3>
                    <p style="color: #666; margin: 0;">
                        {{ item.story.description|default:"No description"|truncatewords:30 }}
                    </p>
                </div>
                <div style="text-align: right; min-width: 150px;">
                    <div style="font-size: 0.875rem; color: #999;">
                        {{ item.play.created_at|date:"M d, Y" }}
                    </div>
                    <div style="font-size: 0.875rem; color: #999;">
                        {{ item.play.created_at|time:"g:i A" }}
                    </div>
                </div>
            </div>

            <!-- Ending Reached -->
            <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #4CAF50; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <strong style="color: #4CAF50;">Ending Reached:</strong>
                    {% if item.ending_page.ending_label %}
                        <span class="badge" style="background: #4CAF50; color: white;">
                            {{ item.ending_page.ending_label }}
                        </span>
                    {% else %}
                        <span class="badge" style="background: #4CAF50; color: white;">
                            Page {{ item.play.ending_page_id }}
                        </span>
                    {% endif %}
                </div>
                
                {% if item.ending_page %}
                    <p style="color: #666; margin: 0.5rem 0 0 2rem; font-style: italic;">
                        "{{ item.ending_page.text|truncatewords:30 }}"
                    </p>
                {% endif %}
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{% url 'play_story' item.story.id %}?resume=false" class="btn btn-success" style="display:flex; align-items:center; gap:10px;">
            <img src="https://img.icons8.com/nolan/25/repeat.png" alt="repeat"/> Play Again
                </a>
                
                <a href="{% url 'story_detail' item.story.id %}" class="btn btn-secondary" style="display:flex; align-items:center; gap:10px;">
                    <img src="https://img.icons8.com/nolan/25/visible.png" alt="visible"/> Story Details
                </a>
            </div>
        </div>
    {% endfor %}

<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h3 style="color: white; margin-bottom: 1rem; display:flex; align-items:center; gap:10px;">
        <img src="https://img.icons8.com/nolan/25/bar-chart.png" alt="bar-chart"/> Your Stats</h3>
    <div class="grid grid-3">
        <div style="text-align: center;">
            <div style="font-size: 2.5rem; font-weight: bold;">{{ play_data|length }}</div>
            <div style="opacity: 0.9;">Stories Completed</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2.5rem; font-weight: bold;">{{ unique_stories_count }}</div>
            <div style="opacity: 0.9;">Unique Stories</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2.5rem; font-weight: bold;">{{ unique_endings_count }}</div>
            <div style="opacity: 0.9;">Different Endings</div>
        </div>
    </div>
</div>

{% else %}
    <div class="card text-center" style="background: #f8f9fa; padding: 3rem;">
        <h2 style="color: #666; margin-bottom: 1rem;"> No Stories Played Yet</h2>
        <p style="color: #999; margin-bottom: 2rem;">
            Start your adventure! Complete stories to see them here.
        </p>
        <a href="{% url 'home' %}" class="btn btn-success" style="font-size: 1.1rem;">
             Browse Stories
        </a>
    </div>
{% endif %}

<div class="text-center">
    <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Back to Home</a>
</div>
{% endblock %}