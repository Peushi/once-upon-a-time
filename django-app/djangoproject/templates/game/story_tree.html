{% extends 'base.html' %}

{% block title %}Story Map: {{ story.title }}{% endblock %}

{% block content %}
<div class="card">
    <h1 style="display:flex; align-items:center; gap:10px;">
            <img src="https://img.icons8.com/nolan/40/adventure.png" alt="adventure"/> Story Map: {{ story.title }}</h1>
    <p>Visual representation of the story structure</p>
    <a href="{% url 'story_detail' story.id %}" class="btn btn-secondary">← Back to Story</a>
</div>

    <div class="card" style="max-width: 1100px; margin: 0 auto;">
    <div style="display:flex; justify-content:flex-end; margin-bottom: 1rem;">
        <button type="button" id="fit-graph" class="btn btn-secondary">Fit to screen</button>
    </div>
    <div id="story-graph"
     style="
        width: 90%;
        height: 750px;
        margin: 0 auto;          
        border-radius: 18px;
        background: #fdeff2;
        overflow: hidden;
     ">
    </div>
</div>

<div class="card" style="
    max-width: 1100px;
    margin: 1.5rem auto 0 auto;
    background: #fdeff2;
    border-radius: 18px;
">
    <h3 style="margin-bottom: 1rem;">Legend</h3>

    <div style="display: flex; gap: 2rem; flex-wrap: wrap; align-items: center;">
        <div>
            <span style="
                display: inline-block;
                width: 18px;
                height: 18px;
                background: #FAD7C6;
                border: 3px solid #FF6FA3;
                border-radius: 10px;
                margin-right: 6px;
            "></span>
            Start Page
        </div>

        <div>
            <span style="
                display: inline-block;
                width: 18px;
                height: 18px;
                background: #F8B8CF;
                border: 3px solid #ffffff;
                border-radius: 10px;
                margin-right: 6px;
            "></span>
            Regular Page
        </div>

        <div>
            <span style="
                display: inline-block;
                width: 18px;
                height: 18px;
                background: #CBB7E8;
                border: 3px solid #B39DDB;
                border-radius: 10px;
                margin-right: 6px;
            "></span>
            Ending
        </div>

        <div>
            <span style="
                display: inline-block;
                width: 34px;
                height: 0;
                border-top: 3px dashed #C8C1FF;
                margin-right: 6px;
            "></span>
            Choice link
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
const treeData = {{ tree_data|safe }};
const container = document.getElementById("story-graph");

//Nodes
const nodes = treeData.nodes.map(n => {
    const isStart = !!n.is_start;
    const isEnding = !!n.is_ending;

    const bg = isStart ? "#FAD7C6" : (isEnding ? "#CBB7E8" : "#F8B8CF");
    const border = isStart ? "#FF6FA3" : (isEnding ? "#B39DDB" : "#FFFFFF");

    const title = `Page ${n.page_number ?? n.id}`;
    const subtitle = isStart
        ? "The Beginning"
        : (n.ending_label ? n.ending_label : "The Choice");

    const iconLine = isStart ? "★" : (isEnding ? "" : "");

    return {
        id: n.id,
        label: `${title}\n${subtitle}\n${iconLine}`,
        shape: "box",
        margin: 20,
        widthConstraint: { minimum: 230, maximum: 320 },
        shapeProperties: { borderRadius: 28 },

        color: {
            background: bg,
            border: border,
            highlight: { background: bg, border: border },
            hover: { background: bg, border: border }
        },

        font: {
            color: "#FFFFFF",
            face: "Arial",
            multi: true,
            size: 22
        },

        shadow: {
            enabled: true,
            size: 26,
            x: 0,
            y: 12
        },

        borderWidth: isStart ? 6 : 3
    };
});

//Edges 
const edges = treeData.edges.map(e => ({
    from: e.from,
    to: e.to,

    dashes: [10, 10],
    smooth: { enabled: true, type: "cubicBezier", roundness: 0.75 }, 
    color: { color: "#C8C1FF", opacity: 0.65 },
    width: 3,

    arrows: { to: { enabled: false } },

    label: (e.text && e.text.length > 18) ? (e.text.slice(0, 16) + "…") : (e.text || "CHOICE"),
    font: {
        size: 14,
        color: "#C8C1FF",
        align: "middle"
    }
}));

//Force levels from start 
const startNode = treeData.nodes.find(n => n.is_start);
if (startNode) {
    const startId = startNode.id;

    const adj = new Map();
    treeData.edges.forEach(e => {
        if (!adj.has(e.from)) adj.set(e.from, []);
        adj.get(e.from).push(e.to);
    });

    const level = new Map();
    const q = [startId];
    level.set(startId, 0);

    while (q.length) {
        const cur = q.shift();
        const nexts = adj.get(cur) || [];
        for (const nxt of nexts) {
            if (!level.has(nxt)) {
                level.set(nxt, level.get(cur) + 1);
                q.push(nxt);
            }
        }
    }

    nodes.forEach(n => {
        if (level.has(n.id)) n.level = level.get(n.id);
    });
}

const data = {
    nodes: new vis.DataSet(nodes),
    edges: new vis.DataSet(edges)
};

//Layout 
const options = {
    physics: false,

    // interaction block
    interaction: { 
        dragNodes: true, 
        dragView: true, 
        zoomView: true,
        zoomKey: "ctrlKey" 
    },

    layout: {
        hierarchical: {
            enabled: true,
            direction: "UD",
            sortMethod: "directed",
            shakeTowards: "roots",
            parentCentralization: true,

            levelSeparation: 330,
            nodeSpacing: 360,
            treeSpacing: 420,

            blockShifting: true,
            edgeMinimization: false
        }
    },
    nodes: { chosen: false },
    edges: { chosen: false }
};

const network = new vis.Network(container, data, options);

// Frame nicely
setTimeout(() => {
    network.fit({ animation: { duration: 600 } });
    network.moveTo({ scale: 0.85 });
}, 50);

//disable accidental double click zoom
document.getElementById('story-graph').addEventListener('dblclick', function(e) {
    e.preventDefault();
});
document.getElementById("fit-graph").addEventListener("click", () => {
  network.fit({ animation: { duration: 600 } });
});
</script>
{% endblock %}